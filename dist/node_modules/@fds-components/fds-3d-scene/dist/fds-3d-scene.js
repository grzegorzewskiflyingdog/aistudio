var app=function(){"use strict";function e(){}function t(e){return e()}function n(){return Object.create(null)}function o(e){e.forEach(t)}function i(e){return"function"==typeof e}function a(e,t){return e!=e?t==t:e!==t||e&&"object"==typeof e||"function"==typeof e}function r(e,t,n){e.insertBefore(t,n||null)}function s(e){e.parentNode&&e.parentNode.removeChild(e)}function c(e,t,n){null==n?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function l(e){const t={};for(const n of e)t[n.name]=n.value;return t}let d;function u(e){d=e}function h(){if(!d)throw new Error("Function called outside component initialization");return d}const m=[],g=[];let p=[];const f=[],B=Promise.resolve();let $=!1;function _(e){p.push(e)}const b=new Set;let x=0;function y(){if(0!==x)return;const e=d;do{try{for(;x<m.length;){const e=m[x];x++,u(e),v(e.$$)}}catch(e){throw m.length=0,x=0,e}for(u(null),m.length=0,x=0;g.length;)g.pop()();for(let e=0;e<p.length;e+=1){const t=p[e];b.has(t)||(b.add(t),t())}p.length=0}while(m.length);for(;f.length;)f.pop()();$=!1,b.clear(),u(e)}function v(e){if(null!==e.fragment){e.update(),o(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(_)}}const w=new Set;function A(e,t){const n=e.$$;null!==n.fragment&&(!function(e){const t=[],n=[];p.forEach((o=>-1===e.indexOf(o)?t.push(o):n.push(o))),n.forEach((e=>e())),p=t}(n.after_update),o(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function L(e,t){-1===e.$$.dirty[0]&&(m.push(e),$||($=!0,B.then(y)),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function O(a,r,c,l,h,m,g,p=[-1]){const f=d;u(a);const B=a.$$={fragment:null,ctx:[],props:m,update:e,not_equal:h,bound:n(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(r.context||(f?f.$$.context:[])),callbacks:n(),dirty:p,skip_bound:!1,root:r.target||f.$$.root};g&&g(B.root);let $=!1;if(B.ctx=c?c(a,r.props||{},((e,t,...n)=>{const o=n.length?n[0]:t;return B.ctx&&h(B.ctx[e],B.ctx[e]=o)&&(!B.skip_bound&&B.bound[e]&&B.bound[e](o),$&&L(a,e)),t})):[],B.update(),$=!0,o(B.before_update),B.fragment=!!l&&l(B.ctx),r.target){if(r.hydrate){const e=function(e){return Array.from(e.childNodes)}(r.target);B.fragment&&B.fragment.l(e),e.forEach(s)}else B.fragment&&B.fragment.c();r.intro&&((b=a.$$.fragment)&&b.i&&(w.delete(b),b.i(x))),function(e,n,a,r){const{fragment:s,after_update:c}=e.$$;s&&s.m(n,a),r||_((()=>{const n=e.$$.on_mount.map(t).filter(i);e.$$.on_destroy?e.$$.on_destroy.push(...n):o(n),e.$$.on_mount=[]})),c.forEach(_)}(a,r.target,r.anchor,r.customElement),y()}var b,x;u(f)}let z;"function"==typeof HTMLElement&&(z=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const{on_mount:e}=this.$$;this.$$.on_disconnect=e.map(t).filter(i);for(const e in this.$$.slotted)this.appendChild(this.$$.slotted[e])}attributeChangedCallback(e,t,n){this[e]=n}disconnectedCallback(){o(this.$$.on_disconnect)}$destroy(){A(this,1),this.$destroy=e}$on(t,n){if(!i(n))return e;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const e=o.indexOf(n);-1!==e&&o.splice(e,1)}}$set(e){var t;this.$$set&&(t=e,0!==Object.keys(t).length)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}});let N=document.currentScript&&document.currentScript.src||new URL("fds-3d-scene.js",document.baseURI).href;class k{static async getInfo(e,t){let n="",o="",i=!1;t&&(t=t.replace("@fds-components/",""),n=k.get_href()+e+"-"+t+".json",o=`@fds-components/${t}/dist/${e}-${t}.json`);let a=await fetch(n).then((e=>(e.ok||(i=!0),e.json()))).then((t=>"api"!==e?t:t?t.components?t.components[0]:t:void 0));return i&&(a=await fetch(o).then((e=>(e.ok||(i=!0),e.json()))).then((t=>"api"!==e?t:t?t.components?t.components[0]:t:void 0))),a}static get_href(){return new URL("./",N).href}static get_local(){return new URL("./",N).pathname}}var M="@fds-components/fds-3d-scene",C="1.0.16";function Y(t){let n;return{c(){n=function(e){return document.createElement(e)}("canvas"),this.c=e,c(n,"id","renderCanvas"),c(n,"width",t[1]),c(n,"height",t[2]),c(n,"class","canvas")},m(e,o){r(e,n,o),t[22](n)},p(e,t){2&t[0]&&c(n,"width",e[1]),4&t[0]&&c(n,"height",e[2])},i:e,o:e,d(e){e&&s(n),t[22](null)}}}function S(e){let t=e;for(;t;){if(t.gizmoHere)return t;t=t.parent}return e}function I(e){if("__root__"===e.parent.name)return!1;for(;"__root__"!==e.parent.name;)if("Mesh"===(e=e.parent).getClassName())return!0;return!1}function E(e){if("__root__"===e.parent.name)return e;for(;"__root__"!==e.parent.name;)e=e.parent;return e}function D(e,t,n){let o=h(),{width:i=1e3}=t,{height:a=1e3}=t,{external_scene_storage:r=null}=t,{move_gizmo_thickness:s=1}=t,{bounding_gizmo_thickness:c=.03}=t,{camera_behaviour:l=""}=t;const d=C;let{base64:u}=t,{binary:m}=t,p=!1;var f;let B;f=()=>(U(j),()=>{r&&n(5,r.data=x(),r)}),h().$$.on_mount.push(f);let{scene:$}=t;function _(e){B?.resize()}let b=function(){return new Promise((e=>{setTimeout((()=>{e("")}),100)}))};function x(){let e=N;Y("");let t={},n=$.activeCamera;t.position=JSON.parse(JSON.stringify(n.position)),t.rotation=JSON.parse(JSON.stringify(n.rotation)),Q.camera=t;for(let e of Q.meshes){let t=$.getMeshByName(e.name);if(!t)return alert("mesh not found"+e.name),null;let n={scaling:t.scaling.clone(),rotationQ:t.rotationQuaternion.clone(),position:t.position.clone()};e.positionData=n}return Y(e),Q}let y,v,w,A,L,O,z,{mode:N=""}=t;function Y(e){L&&(L.opacity=1,L.setParent(null)),A&&A.dispose(),L&&(L.isPickable=!0),A&&(A.isPickable=!1),w&&(w.attachedMesh=null),v&&(v.attachedMesh=null),y&&(y.attachedMesh=null),L&&("move"===e&&(w&&(w.attachedMesh=null),v.attachedMesh=L,L.opacity=.5),"scale_rotate"===e&&(A=BABYLON.BoundingBoxGizmo.MakeNotPickableAndWrapInBoundingBox(L),O.utilityLayerScene.autoClearDepthAndStencil=!1,w=new BABYLON.BoundingBoxGizmo(BABYLON.Color3.FromHexString("#0984e3"),O),w.scaleBoxSize=parseFloat(c),w.rotationSphereSize=parseFloat(c),w.attachedMesh=A))}function D(e){o.dispatchEvent(new CustomEvent("change",{detail:e}))}let G,P,{background_type:R="transparent"}=t,V=null;function F(e="grey"){$&&("transparent"===e&&(V&&(V.dispose(),V=null),n(4,$.clearColor=new BABYLON.Color4(0,0,0,0),$)),"grey"===e&&(V||(V=$.createDefaultEnvironment({enableGroundShadow:!0}),V.setMainColor(BABYLON.Color3.Gray()),V.ground.position.y+=.01),n(4,$.clearColor=G,$)),"black"===e&&(V&&(V.dispose(),V=null),n(4,$.clearColor=new BABYLON.Color4(0,0,0,255),$)))}function U(e){B=new BABYLON.Engine(e,!0,{preserveDrawingBuffer:!0,stencil:!0}),B.enableOfflineSupport=!1,B.resize(),BABYLON.Animation.AllowMatricesInterpolation=!0,n(4,$=new BABYLON.Scene(B)),G=$.clearColor;let t=new BABYLON.ArcRotateCamera("camera1",Math.PI/2,Math.PI/2,3,new BABYLON.Vector3(0,1,0),$);t.attachControl(e,!0),t.lowerRadiusLimit=1.2,t.upperRadiusLimit=8,t.wheelDeltaPercentage=.01,t.onViewMatrixChangedObservable.add((()=>{D({type:"camera",position:t.position,rotation:t.rotation})}));let o=new BABYLON.HemisphericLight("light1",new BABYLON.Vector3(0,1,0),$);o.intensity=.6,o.specular=BABYLON.Color3.Black();let i=new BABYLON.DirectionalLight("dir01",new BABYLON.Vector3(0,-.5,-1),$);i.position=new BABYLON.Vector3(0,5,5);let a=new BABYLON.ShadowGenerator(1024,i);a.useBlurExponentialShadowMap=!0,a.blurKernel=32;var r=new BABYLON.GridMaterial("groundMaterial",$);r.majorUnitFrequency=1,r.minorUnitVisibility=.1,r.gridRatio=1,r.backFaceCulling=!1,r.mainColor=new BABYLON.Color3(0,0,0),r.lineColor=new BABYLON.Color3(0,0,0),r.opacity=.2,BABYLON.Mesh.CreateGround("ground1",20,20,2,$).material=r,F(R),function(){let e;O=new BABYLON.UtilityLayerRenderer($),z=new BABYLON.UtilityLayerRenderer($),v=new BABYLON.PositionGizmo(z,parseInt(s)),y=new BABYLON.RotationGizmo(O),w=new BABYLON.ScaleGizmo(O),v.xGizmo.dragBehavior.onDragEndObservable.add((()=>{D({type:"position",axis:"x"})})),v.yGizmo.dragBehavior.onDragEndObservable.add((()=>{D({type:"position",axis:"y"})})),v.zGizmo.dragBehavior.onDragEndObservable.add((()=>{D({type:"position",axis:"z"})})),y.xGizmo.dragBehavior.onDragEndObservable.add((()=>{D({type:"rotation",axis:"x"})})),y.yGizmo.dragBehavior.onDragEndObservable.add((()=>{D({type:"rotation",axis:"y"})})),y.zGizmo.dragBehavior.onDragEndObservable.add((()=>{D({type:"rotation",axis:"z"})})),w.xGizmo.dragBehavior.onDragEndObservable.add((()=>{D({type:"scale",axis:"x"})})),w.yGizmo.dragBehavior.onDragEndObservable.add((()=>{D({type:"scale",axis:"y"})})),w.zGizmo.dragBehavior.onDragEndObservable.add((()=>{D({type:"scale",axis:"z"})})),new BABYLON.AxisScaleGizmo(new BABYLON.Vector3(0,1,0),BABYLON.Color3.FromHexString("#00b894"),O).attachedNode=null,y.updateGizmoRotationToMatchAttachedMesh=!1,y.updateGizmoPositionToMatchAttachedMesh=!0,v.updateGizmoPositionToMatchAttachedMesh=!0,n(4,$.onPointerDown=function(){const t=$.pick(this.pointerX,this.pointerY);if(t.hit&&(e=t.pickedMesh.name),t.hit&&"ground1"!==e&&"__root__"!==e&&!e.includes("Background")){if("box"===t.pickedMesh.name)return;if("scale_rotate"===N){L&&(L.opacity=1),L&&(L.isPickable=!0),L&&L.setParent(null),A&&A.dispose(),w&&(w.attachedMesh=null);let e=S(t.pickedMesh);A=BABYLON.BoundingBoxGizmo.MakeNotPickableAndWrapInBoundingBox(e),O.utilityLayerScene.autoClearDepthAndStencil=!1,w=new BABYLON.BoundingBoxGizmo(BABYLON.Color3.FromHexString("#0984e3"),O),w.scaleBoxSize=parseFloat(c),w.rotationSphereSize=parseFloat(c),w.attachedMesh=A,L=e}if("move"===N){O.utilityLayerScene.autoClearDepthAndStencil=!0,L&&(L.opacity=1);let e=S(t.pickedMesh);v.attachedMesh=e,L=e,L.opacity=.5}}},$)}(),function(e){e.runRenderLoop((function(){$&&$.activeCamera&&$.render()}))}(B),B.hideLoadingUI(),P=$.enableDepthRenderer()}let Q={meshes:[],camera:{}};async function W(e,t=null){let n={base64:e};await BABYLON.SceneLoader.AppendAsync("",e,$);try{$.stopAllAnimations();let e,o=$.meshes,i=[];for(let e of o)e&&!e.loaded&&(e.loaded=!0,"ground1"===e.name||"__root__"===e.name||e.name.includes("Background")||(i.push(e),i.loaded=!0,i.isPickable=!0));let a=!0;try{e=BABYLON.Mesh.MergeMeshes(i,!0,!0)}catch(t){let n={};for(let e of i){if(!I(e)){let t=E(e);if(n[t.name]){let o=n[t.name];o.min=BABYLON.Vector3.Minimize(o.min,e.getBoundingInfo().boundingBox.minimumWorld),o.max=BABYLON.Vector3.Maximize(o.max,e.getBoundingInfo().boundingBox.maximumWorld)}else{let o={tn:t,min:e.getBoundingInfo().boundingBox.minimumWorld,max:e.getBoundingInfo().boundingBox.maximumWorld};n[t.name]=o}}e.parent}a=!1;for(const t in n){let o=n[t];e=new BABYLON.Mesh("parent",$),o.tn.setParent(e),e.gizmoHere=!0,e.setBoundingInfo(new BABYLON.BoundingInfo(o.min,o.max))}}if(a){e.loaded=!0;let t=e.getBoundingInfo().boundingBox.minimum,n=e.getBoundingInfo().boundingBox.maximum.subtract(t),o=Math.max(n.x,n.y,n.z);e.position=new BABYLON.Vector3(0,0,0),e.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1);let i=1/o;e.scaling=new BABYLON.Vector3(i,i,i)}t&&(e.rotationQuaternion=new BABYLON.Quaternion(t.rotationQ._x,t.rotationQ._y,t.rotationQ._z,t.rotationQ._w),e.position=new BABYLON.Vector3(t.position._x,t.position._y,t.position._z),e.scaling=new BABYLON.Vector3(t.scaling._x,t.scaling._y,t.scaling._z)),n.name=e.name,Q.meshes.push(n)}catch(e){}}let{canvas:j}=t;return e.$$set=e=>{"width"in e&&n(1,i=e.width),"height"in e&&n(2,a=e.height),"external_scene_storage"in e&&n(5,r=e.external_scene_storage),"move_gizmo_thickness"in e&&n(6,s=e.move_gizmo_thickness),"bounding_gizmo_thickness"in e&&n(7,c=e.bounding_gizmo_thickness),"camera_behaviour"in e&&n(8,l=e.camera_behaviour),"base64"in e&&n(3,u=e.base64),"binary"in e&&n(11,m=e.binary),"scene"in e&&n(4,$=e.scene),"mode"in e&&n(16,N=e.mode),"background_type"in e&&n(19,R=e.background_type),"canvas"in e&&n(0,j=e.canvas)},e.$$.update=()=>{2097152&e.$$.dirty[0]&&!p&&o&&(n(21,p=!0),new ResizeObserver(_).observe(o)),e.$$.dirty[0],524288&e.$$.dirty[0]&&R&&F(R),65536&e.$$.dirty[0]&&Y(N),273&e.$$.dirty[0]&&$&&(l||$.activeCamera.attachControl(j,!0),"lock"===l&&$.activeCamera.detachControl()),2048&e.$$.dirty[0]&&m&&n(3,u="data:base64,"+function(e){let t="";for(var n,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=new Uint8Array(e),a=i.byteLength,r=a%3,s=a-r,c=0;c<s;c+=3)t+=o[(16515072&(n=i[c]<<16|i[c+1]<<8|i[c+2]))>>18]+o[(258048&n)>>12]+o[(4032&n)>>6]+o[63&n];return 1==r?t+=o[(252&(n=i[s]))>>2]+o[(3&n)<<4]+"==":2==r&&(t+=o[(64512&(n=i[s]<<8|i[s+1]))>>10]+o[(1008&n)>>4]+o[(15&n)<<2]+"="),t}(m)),8&e.$$.dirty[0]&&u&&W(u)},[j,i,a,u,$,r,s,c,l,async function(e){return"version"===e?new Promise((e=>{e(C)})):await k.getInfo(e,M)},d,m,async function(){let e=$.meshes;if(!e.length)return;Y("");let t=e[0].getBoundingInfo().boundingBox.minimumWorld,o=e[0].getBoundingInfo().boundingBox.maximumWorld;for(let n of e)if("ground1"!==n.name&&"__root__"!==n.name&&!n.name.includes("Background")){const e=n.getBoundingInfo().boundingBox.minimumWorld,i=n.getBoundingInfo().boundingBox.maximumWorld;t=BABYLON.Vector3.Minimize(t,e),o=BABYLON.Vector3.Maximize(o,i)}let i=Math.max(o.x,o.y),a=$.activeCamera.minZ,r=$.activeCamera.maxZ;n(4,$.activeCamera.minZ=1.2,$),n(4,$.activeCamera.maxZ=i,$),await b();let s=P.getDepthMap(),c=j.width,l=j.height,d=new Promise((e=>{s.readPixels().then((t=>{for(let e=0;e<t.length;e+=4)t[e+1]=t[e+2]=t[e];BABYLON.Tools.DumpData(s.getSize().width,s.getSize().height,t,(t=>{let n=window.document.createElement("canvas");n.width=c,n.height=l;const o=new Image;o.src=t,o.onload=()=>{let t=n.getContext("2d");t.scale(1,-1),t.filter="invert(1)",t.drawImage(o,0,-l,c,l);let i=n.toDataURL();e(i)}}))}))})),u=await d;return n(4,$.activeCamera.minZ=a,$),n(4,$.activeCamera.maxZ=r,$),u},x,async function(e){Q.meshes=[],$.dispose(),U(j);let t=$.activeCamera;t.position=e.camera.position,t.rotation=e.camera.rotation;for(let t of e.meshes)await W(t.base64,t.positionData);Y("")},async function(){let e=N;Y(""),await b();let t=j.toDataURL();return Y(e),t},N,Y,function(){if(!L)return;let e=L.name;L.dispose(),L=null,Y("");let t=0;for(let n of Q.meshes){if(n.name===e)return void Q.meshes.splice(t,-1);t++}},R,F,p,function(e){g[e?"unshift":"push"]((()=>{j=e,n(0,j)}))}]}class G extends z{constructor(e){super();const t=document.createElement("style");t.textContent=".canvas{width:100%;height:100%}*{box-sizing:border-box}",this.shadowRoot.appendChild(t),O(this,{target:this.shadowRoot,props:l(this.attributes),customElement:!0},D,Y,a,{width:1,height:2,external_scene_storage:5,move_gizmo_thickness:6,bounding_gizmo_thickness:7,camera_behaviour:8,getInfo:9,version:10,base64:3,binary:11,scene:4,renderForAI:12,getScene:13,setScene:14,renderNormal:15,mode:16,setMode:17,deleteMesh:18,background_type:19,setBackground:20,canvas:0},null,[-1,-1]),e&&(e.target&&r(e.target,this,e.anchor),e.props&&(this.$set(e.props),y()))}static get observedAttributes(){return["width","height","external_scene_storage","move_gizmo_thickness","bounding_gizmo_thickness","camera_behaviour","getInfo","version","base64","binary","scene","renderForAI","getScene","setScene","renderNormal","mode","setMode","deleteMesh","background_type","setBackground","canvas"]}get width(){return this.$$.ctx[1]}set width(e){this.$$set({width:e}),y()}get height(){return this.$$.ctx[2]}set height(e){this.$$set({height:e}),y()}get external_scene_storage(){return this.$$.ctx[5]}set external_scene_storage(e){this.$$set({external_scene_storage:e}),y()}get move_gizmo_thickness(){return this.$$.ctx[6]}set move_gizmo_thickness(e){this.$$set({move_gizmo_thickness:e}),y()}get bounding_gizmo_thickness(){return this.$$.ctx[7]}set bounding_gizmo_thickness(e){this.$$set({bounding_gizmo_thickness:e}),y()}get camera_behaviour(){return this.$$.ctx[8]}set camera_behaviour(e){this.$$set({camera_behaviour:e}),y()}get getInfo(){return this.$$.ctx[9]}get version(){return this.$$.ctx[10]}get base64(){return this.$$.ctx[3]}set base64(e){this.$$set({base64:e}),y()}get binary(){return this.$$.ctx[11]}set binary(e){this.$$set({binary:e}),y()}get scene(){return this.$$.ctx[4]}set scene(e){this.$$set({scene:e}),y()}get renderForAI(){return this.$$.ctx[12]}get getScene(){return this.$$.ctx[13]}get setScene(){return this.$$.ctx[14]}get renderNormal(){return this.$$.ctx[15]}get mode(){return this.$$.ctx[16]}set mode(e){this.$$set({mode:e}),y()}get setMode(){return this.$$.ctx[17]}get deleteMesh(){return this.$$.ctx[18]}get background_type(){return this.$$.ctx[19]}set background_type(e){this.$$set({background_type:e}),y()}get setBackground(){return this.$$.ctx[20]}get canvas(){return this.$$.ctx[0]}set canvas(e){this.$$set({canvas:e}),y()}}return customElements.define("fds-3d-scene",G),G}();
